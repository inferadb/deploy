apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Prefix all resource names with 'dev-' to differentiate from staging/production
namePrefix: dev-

# Inherit from base and add dev-specific resources
resources:
  - ../base
  # Dev uses Tailscale for automatic HTTPS (no port-forward needed)
  - ../base/tailscale
  # Mailpit for email testing in dev
  - ../base/mailpit

# Dev-specific patches
patches:
  # Local registry image patches (generated by `inferadb dev start`)
  - path: registry-patch.yaml

  # Allow privileged workloads in inferadb namespace (some containers need elevated permissions)
  - target:
      kind: Namespace
      name: inferadb
    patch: |-
      - op: replace
        path: /metadata/labels/pod-security.kubernetes.io~1enforce
        value: privileged
      - op: replace
        path: /metadata/labels/pod-security.kubernetes.io~1warn
        value: privileged
      - op: replace
        path: /metadata/labels/pod-security.kubernetes.io~1audit
        value: privileged

  # Reduce engine replicas and resources for dev
  - target:
      kind: Deployment
      name: inferadb-engine
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 50m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 64Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 200m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 256Mi
      # Update init container to use dev-prefixed Ledger service
      - op: replace
        path: /spec/template/spec/initContainers/0/env/0/value
        value: dev-inferadb-ledger-client.inferadb

  # Reduce control replicas and resources for dev
  # Note: Control needs more memory for concurrent test load (e2e tests run 33 parallel tests)
  - target:
      kind: Deployment
      name: inferadb-control
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 100m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 256Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 512Mi
      # Update init container to use dev-prefixed Ledger service
      - op: replace
        path: /spec/template/spec/initContainers/0/env/0/value
        value: dev-inferadb-ledger-client.inferadb

  # Reduce dashboard resources for dev
  - target:
      kind: Deployment
      name: inferadb-dashboard
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 25m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 32Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 100m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 128Mi

  # Dev-prefixed Tailscale hostnames (avoid conflicts with staging/production)
  - target:
      kind: Ingress
      name: inferadb-api-tailscale
    patch: |-
      - op: replace
        path: /spec/tls/0/hosts/0
        value: inferadb-dev-api
  - target:
      kind: Ingress
      name: inferadb-dashboard-tailscale
    patch: |-
      - op: replace
        path: /spec/tls/0/hosts/0
        value: inferadb-dev-dashboard
  - target:
      kind: Ingress
      name: inferadb-mailpit-tailscale
    patch: |-
      - op: replace
        path: /spec/tls/0/hosts/0
        value: inferadb-dev-mailpit

  # Update engine config with dev-prefixed service URLs
  - target:
      kind: ConfigMap
      name: inferadb-engine-config
    patch: |-
      - op: replace
        path: /data/INFERADB__ENGINE__MESH__URL
        value: "http://dev-inferadb-control.inferadb:9092"
      - op: replace
        path: /data/INFERADB__ENGINE__LEDGER__ENDPOINT
        value: "http://dev-inferadb-ledger-client.inferadb:50051"

  # Update control config with dev-prefixed service URLs
  - target:
      kind: ConfigMap
      name: inferadb-control-config
    patch: |-
      - op: replace
        path: /data/INFERADB__CONTROL__FRONTEND__URL
        value: "http://dev-inferadb-dashboard.inferadb:3000"
      - op: replace
        path: /data/INFERADB__CONTROL__EMAIL__HOST
        value: "dev-mailpit.inferadb"
      - op: replace
        path: /data/INFERADB__CONTROL__MESH__URL
        value: "http://dev-inferadb-engine.inferadb"
      - op: replace
        path: /data/CONTROL_API_AUDIENCE
        value: "http://dev-inferadb-control.inferadb:9092"
      - op: replace
        path: /data/INFERADB__CONTROL__LEDGER__ENDPOINT
        value: "http://dev-inferadb-ledger-client.inferadb:50051"

# Disable HPA for dev (single replica, no autoscaling needed)
  - target:
      kind: HorizontalPodAutoscaler
      name: inferadb-engine
    patch: |-
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: inferadb-engine
  - target:
      kind: HorizontalPodAutoscaler
      name: inferadb-control
    patch: |-
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: inferadb-control

  # Disable PDB for dev (single replica, would block all evictions)
  - target:
      kind: PodDisruptionBudget
      name: inferadb-engine
    patch: |-
      $patch: delete
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: inferadb-engine
  - target:
      kind: PodDisruptionBudget
      name: inferadb-control
    patch: |-
      $patch: delete
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: inferadb-control
  - target:
      kind: PodDisruptionBudget
      name: inferadb-ledger
    patch: |-
      $patch: delete
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: inferadb-ledger

  # Reduce ledger replicas and resources for dev (single node, no Raft needed)
  - target:
      kind: StatefulSet
      name: inferadb-ledger
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 50m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 128Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 512Mi

  # Update ledger config for single-node dev mode
  - target:
      kind: ConfigMap
      name: inferadb-ledger-config
    patch: |-
      - op: replace
        path: /data/INFERADB__LEDGER__DISCOVERY_DOMAIN
        value: "dev-inferadb-ledger.inferadb.svc.cluster.local"
      - op: replace
        path: /data/INFERADB__LEDGER__BOOTSTRAP_EXPECT
        value: "1"

# Dev-specific labels
labels:
  - pairs:
      environment: dev
