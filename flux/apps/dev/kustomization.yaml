apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Inherit from base and add dev-specific resources
resources:
  - ../base
  # Dev uses Tailscale for automatic HTTPS (no port-forward needed)
  - ../base/tailscale
  # Mailpit for email testing in dev
  - ../base/mailpit

# Dev-specific patches
patches:
  # Local registry image patches (generated by `inferadb dev start`)
  - path: registry-patch.yaml

  # Allow privileged workloads in inferadb namespace (FDB requires it)
  - target:
      kind: Namespace
      name: inferadb
    patch: |-
      - op: replace
        path: /metadata/labels/pod-security.kubernetes.io~1enforce
        value: privileged
      - op: replace
        path: /metadata/labels/pod-security.kubernetes.io~1warn
        value: privileged
      - op: replace
        path: /metadata/labels/pod-security.kubernetes.io~1audit
        value: privileged

  # Reduce engine replicas and resources for dev
  - target:
      kind: Deployment
      name: inferadb-engine
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 50m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 64Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 200m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 256Mi

  # Reduce control replicas and resources for dev
  # Note: Control needs more memory for concurrent test load (e2e tests run 33 parallel tests)
  - target:
      kind: Deployment
      name: inferadb-control
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 100m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 256Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 512Mi

  # Reduce dashboard resources for dev
  - target:
      kind: Deployment
      name: inferadb-dashboard
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 25m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 32Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 100m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 128Mi

  # Dev-prefixed Tailscale hostnames (avoid conflicts with staging/production)
  - target:
      kind: Ingress
      name: inferadb-api-tailscale
    patch: |-
      - op: replace
        path: /spec/tls/0/hosts/0
        value: inferadb-dev-api
  - target:
      kind: Ingress
      name: inferadb-dashboard-tailscale
    patch: |-
      - op: replace
        path: /spec/tls/0/hosts/0
        value: inferadb-dev-dashboard
  - target:
      kind: Ingress
      name: inferadb-mailpit-tailscale
    patch: |-
      - op: replace
        path: /spec/tls/0/hosts/0
        value: inferadb-dev-mailpit

# Dev-specific labels
labels:
  - pairs:
      environment: dev
