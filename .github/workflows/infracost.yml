# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
#
# Infracost - Cloud cost estimates for Terraform pull requests
# Shows cost impact of infrastructure changes before they're deployed.
#
# Required secrets:
#   - INFRACOST_API_KEY: API key from https://www.infracost.io/docs/#get-api-key
#
# Security Review: This workflow does NOT use any untrusted user inputs in run commands.
# All GitHub context usage is limited to safe values and secrets.

name: Infracost

on:
  pull_request:
    branches: [main]
    paths:
      - "terraform/**/*.tf"
      - "terraform/**/*.tfvars"
      - "infracost.yml"

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  # Default provider for cost estimation (can be aws, gcp, or digitalocean)
  DEFAULT_PROVIDER: aws

jobs:
  infracost:
    name: Infracost Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout base branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Setup Infracost
        uses: infracost/actions/setup@3c5c45c95e4e381c67be847ca45fb2d13c2a1f53 # v3.0.2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "1.10.0"
          terraform_wrapper: false

      - name: Initialize Terraform modules (base)
        run: |
          # Initialize all environment directories for cost estimation
          for dir in terraform/environments/*/; do
            echo "::group::Initializing $dir"
            terraform -chdir="$dir" init -backend=false -input=false
            echo "::endgroup::"
          done

      - name: Generate Infracost cost estimate (base)
        run: |
          infracost breakdown \
            --config-file=infracost.yml \
            --usage-file=infracost-usage.yml \
            --format=json \
            --out-file=/tmp/infracost-base.json

      - name: Checkout PR branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Initialize Terraform modules (PR)
        run: |
          # Initialize all environment directories for cost estimation
          for dir in terraform/environments/*/; do
            echo "::group::Initializing $dir"
            terraform -chdir="$dir" init -backend=false -input=false
            echo "::endgroup::"
          done

      - name: Generate Infracost diff
        run: |
          infracost diff \
            --config-file=infracost.yml \
            --usage-file=infracost-usage.yml \
            --format=json \
            --compare-to=/tmp/infracost-base.json \
            --out-file=/tmp/infracost-diff.json

      - name: Post Infracost comment
        uses: infracost/actions/comment@3c5c45c95e4e381c67be847ca45fb2d13c2a1f53 # v3.0.2
        with:
          path: /tmp/infracost-diff.json
          behavior: update

  # Separate job for breakdown report (useful for main branch pushes)
  breakdown:
    name: Cost Breakdown Report
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Infracost
        uses: infracost/actions/setup@3c5c45c95e4e381c67be847ca45fb2d13c2a1f53 # v3.0.2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "1.10.0"
          terraform_wrapper: false

      - name: Initialize Terraform modules
        run: |
          for dir in terraform/environments/*/; do
            echo "::group::Initializing $dir"
            terraform -chdir="$dir" init -backend=false -input=false
            echo "::endgroup::"
          done

      - name: Generate cost breakdown
        run: |
          infracost breakdown \
            --config-file=infracost.yml \
            --usage-file=infracost-usage.yml \
            --format=table

      - name: Upload to Infracost Cloud
        run: |
          infracost upload \
            --config-file=infracost.yml \
            --path=/tmp/infracost.json || true
        env:
          INFRACOST_ENABLE_CLOUD: true
