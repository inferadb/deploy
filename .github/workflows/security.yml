# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
#
# Security Review: This workflow does NOT use any untrusted user inputs in run commands.
# All GitHub context usage is limited to safe values: needs.*.result and secrets.

name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 6am UTC for drift detection
    - cron: "0 6 * * 1"

# Cancel in-progress runs for PRs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read

jobs:
  # Trivy IaC scanning for misconfigurations
  trivy-iac:
    name: Trivy IaC Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Trivy IaC scanner (Terraform)
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: "config"
          scan-ref: "terraform/"
          format: "sarif"
          output: "trivy-terraform.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"

      - name: Run Trivy IaC scanner (Kubernetes)
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: "config"
          scan-ref: "flux/"
          format: "sarif"
          output: "trivy-kubernetes.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"

      - name: Upload Trivy Terraform results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-terraform.sarif"
          category: "trivy-terraform"

      - name: Upload Trivy Kubernetes results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-kubernetes.sarif"
          category: "trivy-kubernetes"

  # Secret detection with Gitleaks
  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # Checkov compliance scanning
  checkov:
    name: Checkov Compliance
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Checkov on Terraform
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          output_format: sarif
          output_file_path: checkov-terraform.sarif
          soft_fail: true
          skip_check: CKV_TF_1

      - name: Run Checkov on Kubernetes
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: flux/
          framework: kubernetes
          output_format: sarif
          output_file_path: checkov-kubernetes.sarif
          soft_fail: true
          # Skip Flux-generated gotk-components (vendor code we don't control)
          skip_path: flux/clusters/dev-local/flux-system/gotk-components.yaml,flux/clusters/staging/flux-system/gotk-components.yaml,flux/clusters/production/flux-system/gotk-components.yaml

      - name: Upload Checkov Terraform results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-terraform.sarif
          category: "checkov-terraform"

      - name: Upload Checkov Kubernetes results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-kubernetes.sarif
          category: "checkov-kubernetes"

  # KICS (Keeping Infrastructure as Code Secure) scanning
  kics:
    name: KICS Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run KICS scan
        uses: Checkmarx/kics-github-action@530ac1f8efe6202b0f12c9a6e952597ae707b755 # v2.1.3
        with:
          path: "terraform/,flux/,policies/"
          output_path: kics-results/
          output_formats: "sarif"
          fail_on: high
          enable_comments: true
        continue-on-error: true

      - name: Upload KICS results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: kics-results/results.sarif
          category: "kics"

  # Security scan summary
  security-summary:
    name: Security Summary
    needs: [trivy-iac, gitleaks, checkov, kics]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Security scan results
        env:
          TRIVY_RESULT: ${{ needs.trivy-iac.result }}
          GITLEAKS_RESULT: ${{ needs.gitleaks.result }}
          CHECKOV_RESULT: ${{ needs.checkov.result }}
          KICS_RESULT: ${{ needs.kics.result }}
        run: |
          echo "## Security Scan Results"
          echo ""
          echo "| Scanner | Status |"
          echo "|---------|--------|"
          echo "| Trivy IaC | $TRIVY_RESULT |"
          echo "| Gitleaks | $GITLEAKS_RESULT |"
          echo "| Checkov | $CHECKOV_RESULT |"
          echo "| KICS | $KICS_RESULT |"

          # Fail if gitleaks found secrets
          if [[ "$GITLEAKS_RESULT" == "failure" ]]; then
            echo "::error::Gitleaks detected secrets in the codebase!"
            exit 1
          fi

          echo ""
          echo "Security scans completed. Check the Security tab for detailed findings."
