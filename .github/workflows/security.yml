# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
#
# Security Review: This workflow does NOT use any untrusted user inputs in run commands.
# All GitHub context usage is limited to safe values: needs.*.result and secrets.

name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    # Manual trigger from GitHub UI (runs on selected branch, typically main)
  schedule:
    # Run weekly on Monday at 6am UTC for drift detection
    - cron: "0 6 * * 1"

# Cancel in-progress runs for PRs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read

jobs:
  # Trivy IaC scanning for misconfigurations
  trivy-iac:
    name: Trivy IaC Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Trivy IaC scanner (Terraform)
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: "config"
          scan-ref: "terraform/"
          format: "sarif"
          output: "trivy-terraform.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"
          version: "v0.60.0" # Pin to stable version (v0.65.0 has panic bugs)

      - name: Run Trivy IaC scanner (Kubernetes)
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # 0.30.0
        with:
          scan-type: "config"
          scan-ref: "flux/"
          format: "sarif"
          output: "trivy-kubernetes.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"
          version: "v0.60.0" # Pin to stable version (v0.65.0 has panic bugs)

      - name: Upload Trivy Terraform results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-terraform.sarif"
          category: "trivy-terraform"

      - name: Upload Trivy Kubernetes results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-kubernetes.sarif"
          category: "trivy-kubernetes"

  # Checkov compliance scanning
  checkov:
    name: Checkov Compliance
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Checkov on Terraform
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          output_format: sarif
          output_file_path: checkov-terraform.sarif
          soft_fail: true
          compact: true
          quiet: true
          skip_check: CKV_TF_1

      - name: Run Checkov on Kubernetes
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: flux/
          framework: kubernetes
          output_format: sarif
          output_file_path: checkov-kubernetes.sarif
          soft_fail: true
          compact: true
          quiet: true
          # Skip Flux-generated gotk-components, flux-system directories (vendor code),
          # and auto-generated dev registry patches (local development only)
          skip_path: flux/clusters/dev-local/flux-system,flux/clusters/staging/flux-system,flux/clusters/production/flux-system,flux/apps/dev/registry-patch.yaml
          # Skip checks that are handled elsewhere or intentional design choices:
          # - CKV_K8S_14/43: Image tags managed by Flux image automation
          # - CKV2_K8S_6: NetworkPolicies are CiliumNetworkPolicy in policies/
          # - CKV_K8S_22: Dashboard needs writable fs for Next.js
          # - CKV_K8S_35: Secrets as env vars is acceptable for optional config
          skip_check: CKV_K8S_14,CKV_K8S_43,CKV2_K8S_6,CKV_K8S_22,CKV_K8S_35

      - name: Upload Checkov Terraform results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-terraform.sarif
          category: "checkov-terraform"

      - name: Upload Checkov Kubernetes results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-kubernetes.sarif
          category: "checkov-kubernetes"

  # KICS (Keeping Infrastructure as Code Secure) scanning
  kics:
    name: KICS Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run KICS scan
        uses: Checkmarx/kics-github-action@530ac1f8efe6202b0f12c9a6e952597ae707b755 # v2.1.3
        with:
          path: "terraform/,flux/,policies/"
          output_path: kics-results/
          output_formats: "sarif"
          fail_on: high
          enable_comments: true
        continue-on-error: true

      - name: Upload KICS results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: kics-results/results.sarif
          category: "kics"

  # Security scan summary
  security-summary:
    name: Security Summary
    needs: [trivy-iac, checkov, kics]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Security scan results
        env:
          TRIVY_RESULT: ${{ needs.trivy-iac.result }}
          CHECKOV_RESULT: ${{ needs.checkov.result }}
          KICS_RESULT: ${{ needs.kics.result }}
        run: |
          echo "## Security Scan Results"
          echo ""
          echo "| Scanner | Status |"
          echo "|---------|--------|"
          echo "| Trivy IaC | $TRIVY_RESULT |"
          echo "| Checkov | $CHECKOV_RESULT |"
          echo "| KICS | $KICS_RESULT |"
          echo ""
          echo "Secret scanning is handled by GitHub's native push protection."
          echo "Security scans completed. Check the Security tab for detailed findings."
