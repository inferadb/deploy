# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
#
# Security Review: This workflow does NOT use any untrusted user inputs in run commands.
# All GitHub context usage is limited to safe values: needs.*.result, steps.*.outcome,
# github.event_name, github.ref, and secrets.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    # Manual trigger from GitHub UI (runs on selected branch, typically main)

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default to read-only permissions
permissions:
  contents: read

jobs:
  # Detect which file types changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      terraform: ${{ steps.filter.outputs.terraform }}
      kubernetes: ${{ steps.filter.outputs.kubernetes }}
      scripts: ${{ steps.filter.outputs.scripts }}
      talos: ${{ steps.filter.outputs.talos }}
      policies: ${{ steps.filter.outputs.policies }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check for changes
        id: filter
        uses: step-security/paths-filter@6eee183b0d2fd101d3f8ee2935c127bca14c5625 # v3.0.5
        with:
          filters: |
            terraform:
              - 'terraform/**/*.tf'
              - 'terraform/**/*.tfvars'
              - '.tflint.hcl'
            kubernetes:
              - 'flux/**/*.yaml'
              - 'flux/**/*.yml'
            scripts:
              - 'scripts/**/*.sh'
            talos:
              - 'talos/**/*.yaml'
              - 'talos/**/*.yml'
            policies:
              - 'policies/**/*.yaml'
              - 'policies/**/*.yml'

  # Terraform validation
  terraform-validate:
    name: Terraform Validation
    needs: changes
    if: needs.changes.outputs.terraform == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "1.10.0"

      - name: Check formatting
        id: fmt
        run: terraform fmt -check -recursive -diff terraform/
        continue-on-error: true

      - name: Initialize and validate modules
        id: validate
        run: |
          validation_failed=0
          for dir in terraform/modules/*/; do
            echo "::group::Validating $dir"
            if ! terraform -chdir="$dir" init -backend=false -input=false; then
              echo "::error::Failed to init $dir"
              validation_failed=1
            elif ! terraform -chdir="$dir" validate; then
              echo "::error::Validation failed for $dir"
              validation_failed=1
            else
              echo "Validation passed for $dir"
            fi
            echo "::endgroup::"
          done
          exit $validation_failed

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6.2.1
        with:
          tflint_version: v0.55.0

      - name: Initialize TFLint
        run: tflint --init

      - name: Run TFLint
        id: tflint
        run: tflint --recursive --format compact terraform/
        continue-on-error: true

      - name: Fail if format check failed
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "::error::Terraform formatting check failed. Run 'terraform fmt -recursive' to fix."
          exit 1

  # Kubernetes/Flux manifest validation
  kubernetes-validate:
    name: Kubernetes Validation
    needs: changes
    if: needs.changes.outputs.kubernetes == 'true' || needs.changes.outputs.policies == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Python (for yamllint)
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: Install yamllint
        run: pip install yamllint

      - name: Install Kustomize
        uses: imranismail/setup-kustomize@2ba527d4d055ab63514ba50a99456fc35684947f # v2.1.0

      - name: Install kubeconform
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: YAML Lint
        run: yamllint -c .yamllint.yml flux/ talos/ policies/

      - name: Kustomize build validation
        run: |
          build_failed=0
          # Find all directories containing kustomization.yaml
          while IFS= read -r -d '' kustomization; do
            dir=$(dirname "$kustomization")
            echo "::group::Building kustomization for $dir"
            if ! kustomize build "$dir" > /tmp/built.yaml 2>&1; then
              echo "::warning::Kustomize build failed for $dir (may need flux bootstrap)"
              cat /tmp/built.yaml
              # Don't fail - some clusters may not be bootstrapped yet
            else
              echo "Build successful for $dir"
              # Validate built manifests if non-empty
              if [ -s /tmp/built.yaml ]; then
                kubeconform -strict -ignore-missing-schemas /tmp/built.yaml || true
              fi
            fi
            echo "::endgroup::"
          done < <(find flux/ -name "kustomization.yaml" -print0 2>/dev/null)

      - name: Validate NetworkPolicies
        run: |
          echo "Validating NetworkPolicy manifests..."
          find policies/network-policies -name "*.yaml" -exec kubeconform -strict {} \;

  # Shell script validation
  scripts-validate:
    name: Scripts Validation
    needs: changes
    if: needs.changes.outputs.scripts == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ShellCheck
        uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # 2.0.0
        with:
          scandir: "./scripts"
          severity: warning

      - name: Shell syntax check
        run: |
          echo "Checking shell script syntax..."
          find scripts -name "*.sh" -print0 | xargs -0 -I {} bash -n {}
          echo "All scripts have valid syntax"

  # Talos configuration validation
  talos-validate:
    name: Talos Validation
    needs: changes
    if: needs.changes.outputs.talos == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Python (for yamllint)
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate Talos YAML syntax
        run: yamllint -c .yamllint.yml talos/

      - name: Install talosctl
        run: |
          curl -sL https://talos.dev/install | sh

      - name: Validate talconfig structure
        run: |
          echo "Validating Talos configuration structure..."
          if [ -f "talos/talconfig.yaml" ]; then
            python3 -c "import yaml; yaml.safe_load(open('talos/talconfig.yaml'))"
            echo "talconfig.yaml is valid YAML"
          fi

  # Kyverno policy validation
  policy-validate:
    name: Policy Validation
    needs: changes
    if: needs.changes.outputs.policies == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Python (for yamllint)
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate policy YAML syntax
        run: |
          echo "Validating Kyverno policy YAML syntax..."
          yamllint -c .yamllint.yml policies/kyverno/

      - name: Validate policy structure
        run: |
          echo "Validating Kyverno policy structure..."
          for policy in policies/kyverno/*.yaml; do
            # Skip kustomization.yaml
            if [[ "$policy" == *"kustomization.yaml" ]]; then
              continue
            fi
            echo "Checking $policy"
            # Verify it's a valid Kyverno policy (has apiVersion and kind)
            python3 -c "
          import yaml
          import sys
          with open('$policy') as f:
              doc = yaml.safe_load(f)
              if not doc:
                  print(f'Empty policy: $policy')
                  sys.exit(1)
              if doc.get('apiVersion', '').startswith('kyverno.io/'):
                  print(f'Valid Kyverno policy: {doc.get(\"kind\")} - {doc.get(\"metadata\", {}).get(\"name\")}')
              else:
                  print(f'Not a Kyverno policy (apiVersion: {doc.get(\"apiVersion\")})')
          "
          done

  # Overall status check - required for branch protection
  ci-success:
    name: CI Success
    needs:
      [
        changes,
        terraform-validate,
        kubernetes-validate,
        scripts-validate,
        talos-validate,
        policy-validate,
      ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check all jobs
        env:
          TERRAFORM_RESULT: ${{ needs.terraform-validate.result }}
          KUBERNETES_RESULT: ${{ needs.kubernetes-validate.result }}
          SCRIPTS_RESULT: ${{ needs.scripts-validate.result }}
          TALOS_RESULT: ${{ needs.talos-validate.result }}
          POLICIES_RESULT: ${{ needs.policy-validate.result }}
        run: |
          echo "Job Results:"
          echo "  Terraform: $TERRAFORM_RESULT"
          echo "  Kubernetes: $KUBERNETES_RESULT"
          echo "  Scripts: $SCRIPTS_RESULT"
          echo "  Talos: $TALOS_RESULT"
          echo "  Policies: $POLICIES_RESULT"

          # Check for failures (skipped is OK - means no relevant changes)
          for result in "$TERRAFORM_RESULT" "$KUBERNETES_RESULT" "$SCRIPTS_RESULT" "$TALOS_RESULT" "$POLICIES_RESULT"; do
            if [[ "$result" == "failure" ]]; then
              echo "::error::One or more validation jobs failed"
              exit 1
            fi
          done

          echo "All validation checks passed!"
